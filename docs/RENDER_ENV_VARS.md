# متغيرات البيئة على Render — بعد تنفيذ الهجرة

بعد تطبيق [MIGRATION_PLAN](MIGRATION_PLAN.md)، ضع القيم التالية في **Backend Service → Environment** على Render.

---

## 1. قاعدة البيانات (Postgres) — إلزامي

| المفتاح        | القيمة                                                    | ملاحظة                                 |
| -------------- | --------------------------------------------------------- | -------------------------------------- |
| `DATABASE_URL` | `postgresql://user:pass@host:port/dbname?sslmode=require` | من Render Postgres أو Supabase أو Neon |

- **Render Postgres:** Dashboard → إنشاء PostgreSQL → نسخ **Internal Database URL** (أو External إن كان الـ Backend خارج Render).
- **Supabase:** Project → Settings → Database → Connection string (URI).
- **Neon:** مشروع جديد → نسخ connection string.

بدون `DATABASE_URL` يستمر الـ Backend باستخدام SQLite على القرص (يُفقد عند إعادة النشر).

---

## 2. تخزين الملفات (Cloudinary) — إلزامي للإنتاج

| المفتاح                 | القيمة                          | ملاحظة                                       |
| ----------------------- | ------------------------------- | -------------------------------------------- |
| `USE_CLOUDINARY`        | `true`                          | تفعيل رفع الفيديوهات والملفات إلى Cloudinary |
| `CLOUDINARY_CLOUD_NAME` | من لوحة Cloudinary (انظر أدناه) | **ليس** "Root" — هو المعرف الفريد للسحابة    |
| `CLOUDINARY_API_KEY`    | من لوحة Cloudinary              | رقم مثل `868421519827555`                    |
| `CLOUDINARY_API_SECRET` | من لوحة Cloudinary              | سلسلة سرية، لا تضعها في الكود أبداً          |

- تسجيل حساب: [cloudinary.com](https://cloudinary.com)
- **Cloud name:** من [Dashboard](https://console.cloudinary.com) → **Product Credentials** أو **API Keys**. يظهر كـ **Cloud name** (مثلاً `dxyz123abc` أو `my-app-cloud`). القيمة `Root` عادةً **خطأ** — استخدم الاسم الحقيقي من اللوحة.
- بدون هذه القيم (أو مع `USE_CLOUDINARY=false`) تُخزَّن الملفات محلياً على قرص Render ويُفقد عند إعادة النشر.

---

## 3. باقي المتغيرات (كما هي)

| المفتاح                | مثال / ملاحظة                           |
| ---------------------- | --------------------------------------- |
| `SECRET_KEY`           | مفتاح سري قوي (مولّد Django)            |
| `DEBUG`                | `False` في الإنتاج                      |
| `ALLOWED_HOSTS`        | `your-backend.onrender.com` (وفق نطاقك) |
| `CORS_ALLOWED_ORIGINS` | `https://your-frontend.vercel.app`      |

---

## ترتيب التنفيذ

1. إنشاء **Postgres** (Render / Supabase / Neon) وإضافة `DATABASE_URL` → إعادة نشر الـ Backend → تشغيل `migrate` (يحدث تلقائياً في الـ build).
2. إنشاء حساب **Cloudinary** وإضافة `USE_CLOUDINARY` + `CLOUDINARY_*` → إعادة نشر.
3. (اختياري) تشغيل `seed_initial_data` مرة واحدة من Render Shell إذا احتجت بيانات أولية.

---

## التحقق

- بعد النشر: إنشاء مستخدم، إضافة سؤال، رفع فيديو أو ملف.
- إعادة نشر الـ Backend.
- التأكد أن المستخدم والأسئلة والملفات لا تزال موجودة وتعرض بشكل صحيح.

---

## استكشاف الأخطاء: "الفيديوهات والأسئلة تختفي بعد إعادة النشر"

**الظاهرة:** بعد إعادة نشر الـ Backend، الفيديوهات والأسئلة تختفي، لكن Postgres يظهر استخدام تخزين (مثلاً 5%) وCloudinary يظهر استخدام قليل جداً (مثلاً 0.16/25).

**السبب:**

| الخدمة         | ماذا تخزن؟                                                                   | ماذا يحدث؟                                                                                                                                                                                                            |
| -------------- | ---------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **PostgreSQL** | النصوص والبيانات (مستخدمون، دروس، نصوص الأسئلة، **وعناوين/مسارات الملفات**). | قاعدة البيانات **تبقى** بعد إعادة النشر. التخزين المستخدم (مثلاً 5%) = هذه البيانات. لكن إذا كان المسار المحفوظ يشير إلى ملف **محلي** (مثل `media/videos/xyz.mp4`) فالملف نفسه **لم يعد موجوداً** بعد مسح قرص Render. |
| **Cloudinary** | الملفات الفعلية (فيديو، صور، PDF).                                           | إذا كان الاستخدام منخفضاً جداً (مثلاً 0.64%) فمعناه أن الرفع **لم يكن يذهب إلى Cloudinary** عند رفعك السابق — إما `USE_CLOUDINARY` غير مفعّل أو المتغيرات الثلاثة ناقصة/خاطئة.                                        |

**الخلاصة:** البيانات (سجلات الدروس والأسئلة) قد تكون ما زالت في Postgres، لكن **الملفات** كانت تُحفظ على قرص Render المؤقت فانمسحت عند إعادة النشر. Cloudinary لم يُستخدم فعلياً للرفع.

**ما الذي يجب إصلاحه:**

1. **تفعيل Cloudinary على Render بشكل صحيح**
   - Backend Service → **Environment** → تأكد من وجود:
     - `USE_CLOUDINARY` = `true` (حرفياً، بدون مسافات)
     - `CLOUDINARY_CLOUD_NAME` = اسم السحابة من لوحة Cloudinary (مثلاً `ddktakq5v`)
     - `CLOUDINARY_API_KEY` = المفتاح من لوحة Cloudinary
     - `CLOUDINARY_API_SECRET` = السر من لوحة Cloudinary
   - إعادة نشر الـ Backend بعد حفظ المتغيرات.

2. **البيانات والملفات الحالية**
   - **الأسئلة/الدروس (النصوص):** إذا كانت السجلات ما زالت في Postgres، قد تظهر في الواجهة لكن **بدون فيديو/صور** لأن المسارات تشير لملفات محذوفة.
   - **الحل:** إعادة رفع الفيديوهات والصور من لوحة الإدارة. بعد التفعيل الصحيح لـ Cloudinary، الرفع الجديد سيذهب إلى Cloudinary وسيُحفظ الرابط الجديد في Postgres ولن يضيع بعد إعادة النشر.
   - إذا احتجت، يمكنك إعادة تشغيل `seed_initial_data` من Render Shell لملء بيانات أولية، ثم رفع الملفات من جديد.

3. **التحقق أن كل شيء يعمل**
   - بعد إصلاح المتغيرات وإعادة النشر: ارفع فيديو أو صورة من التطبيق.
   - في لوحة Cloudinary: **Media Library** أو **Usage** — يجب أن ترى استخداماً يزيد (مثلاً زيادة في الائتمان المستهلك).
   - أعد نشر الـ Backend مرة أخرى وتأكد أن الفيديو/الصورة ما زالت تعمل.
